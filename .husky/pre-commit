#!/usr/bin/env sh
# Pretty output helpers
RED="\033[31m"; GREEN="\033[32m"; YELLOW="\033[33m"; BOLD="\033[1m"; NC="\033[0m"
print_section() {
  printf "%b\n" "${BOLD}$1${NC}"
  printf "%s\n" "────────────────────────────────────────"
}

# Generic helper to run a command in a directory
run_in_dir() {
  dir="$1"; shift
  (cd "$dir" >/dev/null 2>&1 && "$@")
}

START_TS=$(date +%s)

# Autofix mode (enabled by default): PRECOMMIT_NO_FIX=1 to disable
PRECOMMIT_NO_FIX="${PRECOMMIT_NO_FIX:-0}"
if [ "$PRECOMMIT_NO_FIX" != "1" ]; then
  printf "%b\n" "${YELLOW}Auto-fix enabled: eslint --fix and prettier --write will run (set PRECOMMIT_NO_FIX=1 to disable)${NC}"
fi

# Collect staged files
STAGED_FILES=$(git diff --name-only --cached --diff-filter=ACMR)

# Frontend: staged files
FE_STAGED=$(printf "%s" "$STAGED_FILES" | grep -E '^ayunis-core-frontend/src/.*\.(js|jsx|ts|tsx|json|css|md)$' || true)
FE_TS_STAGED=$(printf "%s" "$STAGED_FILES" | grep -E '^ayunis-core-frontend/src/.*\.(ts|tsx)$' || true)

# Backend: staged TS files
BE_TS_STAGED=$(printf "%s" "$STAGED_FILES" | grep -E '^ayunis-core-backend/(src|apps|libs|test)/.*\.ts$' || true)

# All staged TS/TSX files (for file size check)
ALL_TS_STAGED=$(printf "%s" "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

# Markdown: staged .md files
MD_STAGED=$(printf "%s" "$STAGED_FILES" | grep -E '\.md$' || true)

# Args depending on FIX mode (auto-fix enabled by default)
if [ "$PRECOMMIT_NO_FIX" = "1" ]; then
  FE_PRETTIER_ARGS="--check --log-level warn"
  BE_PRETTIER_ARGS="--check --log-level warn"
  ESLINT_FIX_ARGS=""
else
  FE_PRETTIER_ARGS="--write"
  BE_PRETTIER_ARGS="--write"
  ESLINT_FIX_ARGS="--fix"
fi

# Status files (for parallel jobs)
GIT_DIR=$(git rev-parse --git-dir)
STATUS_DIR="$GIT_DIR/.precommit-status"
mkdir -p "$STATUS_DIR"
FE_PRETTIER_STATUS_FILE="$STATUS_DIR/fe_prettier.status"
FE_TSC_STATUS_FILE="$STATUS_DIR/fe_tsc.status"
FE_ESLINT_STATUS_FILE="$STATUS_DIR/fe_eslint.status"
BE_ESLINT_STATUS_FILE="$STATUS_DIR/be_eslint.status"
BE_PRETTIER_STATUS_FILE="$STATUS_DIR/be_prettier.status"
BE_TSC_STATUS_FILE="$STATUS_DIR/be_tsc.status"
COMPLEXITY_STATUS_FILE="$STATUS_DIR/complexity.status"
DEPCRUISE_STATUS_FILE="$STATUS_DIR/depcruise.status"
FE_DEPCRUISE_STATUS_FILE="$STATUS_DIR/fe_depcruise.status"
BE_DUPLICATION_STATUS_FILE="$STATUS_DIR/be_duplication.status"
FE_DUPLICATION_STATUS_FILE="$STATUS_DIR/fe_duplication.status"
FILE_SIZE_STATUS_FILE="$STATUS_DIR/file_size.status"
MARKDOWNLINT_STATUS_FILE="$STATUS_DIR/markdownlint.status"

# Jobs
run_fe_prettier() {
  STATUS_FILE="$1"
  print_section "Frontend • Prettier (staged)"
  printf "%s\n" "$FE_STAGED" \
    | sed 's#^ayunis-core-frontend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-frontend >/dev/null 2>&1
    printf "%s" "$FE_STAGED" \
      | sed 's#^ayunis-core-frontend/##' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes prettier $FE_PRETTIER_ARGS
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_fe_tsc() {
  STATUS_FILE="$1"
  print_section "Frontend • TypeScript typecheck (staged TS)"
  printf "%s\n" "$FE_TS_STAGED" \
    | sed 's#^ayunis-core-frontend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-frontend >/dev/null 2>&1
    {
      printf "%s\n" "$FE_TS_STAGED" \
        | sed 's#^ayunis-core-frontend/##'
      printf "%s\n" "src/app/routeTree.gen.ts"
    } \
      | sed '/^$/d' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes tsc-files --noEmit -p tsconfig.json
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_fe_eslint() {
  STATUS_FILE="$1"
  print_section "Frontend • ESLint (staged TS)"
  printf "%s\n" "$FE_TS_STAGED" \
    | sed 's#^ayunis-core-frontend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-frontend >/dev/null 2>&1
    printf "%s" "$FE_TS_STAGED" \
      | sed 's#^ayunis-core-frontend/##' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes eslint --format stylish --max-warnings=0 --no-warn-ignored $ESLINT_FIX_ARGS
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_be_eslint() {
  STATUS_FILE="$1"
  print_section "Backend • ESLint (staged TS)"
  printf "%s\n" "$BE_TS_STAGED" \
    | sed 's#^ayunis-core-backend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-backend >/dev/null 2>&1
    printf "%s" "$BE_TS_STAGED" \
      | sed 's#^ayunis-core-backend/##' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes eslint --format stylish --max-warnings=0 $ESLINT_FIX_ARGS
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_be_prettier() {
  STATUS_FILE="$1"
  print_section "Backend • Prettier (staged TS)"
  printf "%s\n" "$BE_TS_STAGED" \
    | sed 's#^ayunis-core-backend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-backend >/dev/null 2>&1
    printf "%s" "$BE_TS_STAGED" \
      | sed 's#^ayunis-core-backend/##' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes prettier $BE_PRETTIER_ARGS
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_be_tsc() {
  STATUS_FILE="$1"
  print_section "Backend • TypeScript typecheck (staged TS)"
  printf "%s\n" "$BE_TS_STAGED" \
    | sed 's#^ayunis-core-backend/##' \
    | sed 's#^# - #'
  set +e
  (
    cd ayunis-core-backend >/dev/null 2>&1
    printf "%s" "$BE_TS_STAGED" \
      | sed 's#^ayunis-core-backend/##' \
      | tr '\n' '\0' \
      | xargs -0 npx --yes tsc-files --noEmit -p tsconfig.json
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_complexity() {
  STATUS_FILE="$1"
  print_section "Complexity • Lizard (staged backend TS)"
  printf "%s\n" "$BE_TS_STAGED" | sed 's#^# - #'
  set +e
  printf "%s" "$BE_TS_STAGED" | tr '\n' ' ' | xargs ./scripts/check-complexity.sh
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_depcruise() {
  STATUS_FILE="$1"
  print_section "Dependencies • dependency-cruiser (backend)"
  set +e
  (
    cd ayunis-core-backend >/dev/null 2>&1
    npm run deps:check --silent
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_fe_depcruise() {
  STATUS_FILE="$1"
  print_section "Dependencies • dependency-cruiser (frontend)"
  set +e
  (
    cd ayunis-core-frontend >/dev/null 2>&1
    npm run deps:check --silent
  )
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_be_duplication() {
  STATUS_FILE="$1"
  print_section "Duplication • jscpd (backend)"
  set +e
  # shellcheck disable=SC2086
  ./scripts/check-duplication.sh ayunis-core-backend $BE_TS_STAGED
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_fe_duplication() {
  STATUS_FILE="$1"
  print_section "Duplication • jscpd (frontend)"
  set +e
  # shellcheck disable=SC2086
  ./scripts/check-duplication.sh ayunis-core-frontend $FE_TS_STAGED
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_file_size() {
  STATUS_FILE="$1"
  print_section "File Size • check-file-size (staged TS/TSX)"
  printf "%s\n" "$ALL_TS_STAGED" | sed 's#^# - #'
  set +e
  # shellcheck disable=SC2086
  ./scripts/check-file-size.sh $ALL_TS_STAGED
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

run_markdownlint() {
  STATUS_FILE="$1"
  print_section "Markdown • markdownlint-cli2 (staged .md)"
  printf "%s\n" "$MD_STAGED" | sed 's#^# - #'
  set +e
  # shellcheck disable=SC2086
  npx --yes markdownlint-cli2 $MD_STAGED
  STATUS=$?
  set -e
  printf "%s" "$STATUS" > "$STATUS_FILE"
}

# Launch jobs in parallel where possible
if [ -n "$FE_STAGED" ]; then
  run_fe_prettier "$FE_PRETTIER_STATUS_FILE" &
fi
if [ -n "$FE_TS_STAGED" ]; then
  run_fe_eslint "$FE_ESLINT_STATUS_FILE" &
  run_fe_tsc "$FE_TSC_STATUS_FILE" &
  run_fe_depcruise "$FE_DEPCRUISE_STATUS_FILE" &
  run_fe_duplication "$FE_DUPLICATION_STATUS_FILE" &
fi
if [ -n "$BE_TS_STAGED" ]; then
  run_be_eslint "$BE_ESLINT_STATUS_FILE" &
  run_be_prettier "$BE_PRETTIER_STATUS_FILE" &
  run_be_tsc "$BE_TSC_STATUS_FILE" &
fi

# Complexity + architecture + duplication checks (backend TS only — lizard/jscpd don't handle JSX well)
if [ -n "$BE_TS_STAGED" ]; then
  run_complexity "$COMPLEXITY_STATUS_FILE" &
  run_depcruise "$DEPCRUISE_STATUS_FILE" &
  run_be_duplication "$BE_DUPLICATION_STATUS_FILE" &
fi

# File size check (all staged TS/TSX)
if [ -n "$ALL_TS_STAGED" ]; then
  run_file_size "$FILE_SIZE_STATUS_FILE" &
fi

# Markdown lint (staged .md files)
if [ -n "$MD_STAGED" ]; then
  run_markdownlint "$MARKDOWNLINT_STATUS_FILE" &
fi

wait

# Read statuses (default 0 when not run)
FE_STATUS=$(cat "$FE_PRETTIER_STATUS_FILE" 2>/dev/null || printf "0")
FE_TSC_STATUS=$(cat "$FE_TSC_STATUS_FILE" 2>/dev/null || printf "0")
FE_ESLINT_STATUS=$(cat "$FE_ESLINT_STATUS_FILE" 2>/dev/null || printf "0")
ESLINT_STATUS=$(cat "$BE_ESLINT_STATUS_FILE" 2>/dev/null || printf "0")
PRETTIER_STATUS=$(cat "$BE_PRETTIER_STATUS_FILE" 2>/dev/null || printf "0")
BE_TSC_STATUS=$(cat "$BE_TSC_STATUS_FILE" 2>/dev/null || printf "0")
COMPLEXITY_STATUS=$(cat "$COMPLEXITY_STATUS_FILE" 2>/dev/null || printf "0")
DEPCRUISE_STATUS=$(cat "$DEPCRUISE_STATUS_FILE" 2>/dev/null || printf "0")
FE_DEPCRUISE_STATUS=$(cat "$FE_DEPCRUISE_STATUS_FILE" 2>/dev/null || printf "0")
BE_DUPLICATION_STATUS=$(cat "$BE_DUPLICATION_STATUS_FILE" 2>/dev/null || printf "0")
FE_DUPLICATION_STATUS=$(cat "$FE_DUPLICATION_STATUS_FILE" 2>/dev/null || printf "0")
FILE_SIZE_STATUS=$(cat "$FILE_SIZE_STATUS_FILE" 2>/dev/null || printf "0")
MARKDOWNLINT_STATUS=$(cat "$MARKDOWNLINT_STATUS_FILE" 2>/dev/null || printf "0")

# Summary and exit code
FAILED=0
if [ -n "$FE_STAGED" ]; then
  if [ "$FE_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Frontend Prettier failed${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Frontend Prettier passed${NC}"
  fi
  if [ -n "$FE_TS_STAGED" ]; then
    if [ "$FE_ESLINT_STATUS" -ne 0 ]; then
      printf "%b\n" "${RED}❌ Frontend ESLint failed${NC}"
      FAILED=1
    else
      printf "%b\n" "${GREEN}✅ Frontend ESLint passed${NC}"
    fi
    if [ "$FE_TSC_STATUS" -ne 0 ]; then
      printf "%b\n" "${RED}❌ Frontend TypeScript typecheck failed${NC}"
      FAILED=1
    else
      printf "%b\n" "${GREEN}✅ Frontend TypeScript typecheck passed${NC}"
    fi
    if [ "$FE_DEPCRUISE_STATUS" -ne 0 ]; then
      printf "%b\n" "${RED}❌ Frontend dependency check failed (FSD violations)${NC}"
      FAILED=1
    else
      printf "%b\n" "${GREEN}✅ Frontend dependency check passed${NC}"
    fi
    if [ "$FE_DUPLICATION_STATUS" -ne 0 ]; then
      printf "%b\n" "${RED}❌ Frontend duplication check failed (copy-paste detected)${NC}"
      FAILED=1
    else
      printf "%b\n" "${GREEN}✅ Frontend duplication check passed${NC}"
    fi
  fi
fi
if [ -n "$BE_TS_STAGED" ]; then
  if [ "$ESLINT_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Backend ESLint failed${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Backend ESLint passed${NC}"
  fi
  if [ "$PRETTIER_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Backend Prettier failed${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Backend Prettier passed${NC}"
  fi
  if [ "$BE_TSC_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Backend TypeScript typecheck failed${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Backend TypeScript typecheck passed${NC}"
  fi
fi

# Complexity check result (backend only)
if [ -n "$BE_TS_STAGED" ]; then
  if [ "$COMPLEXITY_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Complexity check failed (CCN>10, length>50, or args>5)${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Complexity check passed${NC}"
  fi
  if [ "$DEPCRUISE_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Dependency check failed (architecture violations)${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Dependency check passed${NC}"
  fi
  if [ "$BE_DUPLICATION_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Backend duplication check failed (copy-paste detected)${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Backend duplication check passed${NC}"
  fi

fi
if [ -n "$ALL_TS_STAGED" ]; then
  if [ "$FILE_SIZE_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ File size check failed (files exceed line limit)${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ File size check passed${NC}"
  fi
fi
if [ -n "$MD_STAGED" ]; then
  if [ "$MARKDOWNLINT_STATUS" -ne 0 ]; then
    printf "%b\n" "${RED}❌ Markdown lint failed${NC}"
    FAILED=1
  else
    printf "%b\n" "${GREEN}✅ Markdown lint passed${NC}"
  fi
fi

END_TS=$(date +%s)
ELAPSED=$((END_TS - START_TS))

if [ "$FAILED" -ne 0 ]; then
  printf "%b\n" "${RED}${BOLD}Pre-commit checks failed.${NC} Fix the issues above and try again."
  printf "Completed in %ds\n" "$ELAPSED"
  exit 1
else
  printf "%b\n" "${GREEN}${BOLD}All pre-commit checks passed.${NC} ✅"
  printf "Completed in %ds\n" "$ELAPSED"
fi

