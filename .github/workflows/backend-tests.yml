name: Ayunis Core Backend Tests

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Start all containers (postgres, minio, app)
      - name: Start Containers
        run: docker compose -f docker-compose.test.yml up -d

      # Wait for database to be ready
      - name: Wait for Database
        run: |
          timeout 60 bash -c 'until docker exec ayunis-postgres-test pg_isready -U postgres; do sleep 2; done'

      # Run database migrations
      - name: Run Database Migrations
        run: docker exec ayunis-app-test npm run migration:run:dev

      # Run TypeScript type check
      - name: TypeScript Type Check
        run: docker exec ayunis-app-test npx tsc --noEmit

      # Run linting
      - name: Run ESLint
        run: docker exec ayunis-app-test npm run lint

      # Run unit tests with coverage
      - name: Run Unit Tests
        run: docker exec ayunis-app-test npm run test:cov

      # Run e2e tests
      - name: Run E2E Tests
        run: docker exec ayunis-app-test npm run test:e2e

      # Copy coverage reports from container
      - name: Copy Coverage Reports
        if: always()
        run: docker cp ayunis-app-test:/app/coverage ./coverage

      # Upload coverage reports
      - name: Upload Coverage Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/

      # Teardown
      - name: Stop Test Containers
        if: always()
        run: docker compose -f docker-compose.test.yml down -v
