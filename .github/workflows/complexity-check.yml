name: Complexity Check

on:
  pull_request:
    paths:
      - '**/*.ts'
      - '**/*.tsx'

jobs:
  lizard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for diff

      - name: Get changed TypeScript files
        id: changed-files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            **/*.ts
            **/*.tsx

      - name: Install Lizard
        if: steps.changed-files.outputs.any_changed == 'true'
        run: pip install lizard

      - name: Check complexity of changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking complexity for changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' | sed 's/^/  - /'
          echo ""
          
          # Thresholds (from Tweag/Modus experiment)
          CCN_THRESHOLD=10      # Cyclomatic complexity
          LENGTH_THRESHOLD=50   # Function length in lines
          ARGS_THRESHOLD=5      # Number of arguments
          
          # Filter out files where lizard thresholds don't apply:
          # - /generated/: auto-generated API clients
          # - .entity.ts: TypeORM entities (decorators inflate length)
          # - .spec.ts: test files
          # - /db/migrations/: auto-generated migrations
          # - ayunis-core-frontend/: lizard doesn't handle React/JSX well
          # - /email-templates/: MJML HTML strings (CCN=1-2, just long templates)
          # - .command.ts / .query.ts: data-carrier constructors (high arg count is acceptable)
          # - .db-query.ts: raw SQL query functions (high arg count for query params)
          # - unicode-sanitizer.ts: lizard misparses chained .replace() as 85 NLOC (actual: ~25)
          FILTERED=$(echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n' \
            | grep -v '/generated/' \
            | grep -v '\.entity\.ts$' \
            | grep -v '\.spec\.ts$' \
            | grep -v '/db/migrations/' \
            | grep -v '^ayunis-core-frontend/' \
            | grep -v '/email-templates/' \
            | grep -v '\.command\.ts$' \
            | grep -v '\.query\.ts$' \
            | grep -v '\.db-query\.ts$' \
            | grep -v 'unicode-sanitizer\.ts$' \
            || true)
          
          if [ -z "$FILTERED" ]; then
            echo "✅ No non-generated TypeScript files to check"
            exit 0
          fi
          
          echo "After filtering:"
          echo "$FILTERED" | sed 's/^/  - /'
          echo ""
          
          # Run lizard with warnings only
          RESULT=$(echo "$FILTERED" | tr '\n' ' ' | xargs lizard \
            --CCN $CCN_THRESHOLD \
            --length $LENGTH_THRESHOLD \
            --arguments $ARGS_THRESHOLD \
            --warnings_only \
            2>&1) || true
          
          if [ -n "$RESULT" ]; then
            echo "❌ Complexity thresholds exceeded:"
            echo "$RESULT"
            echo ""
            echo "Thresholds: CCN≤$CCN_THRESHOLD, length≤$LENGTH_THRESHOLD lines, args≤$ARGS_THRESHOLD"
            echo "Consider refactoring these functions into smaller units."
            exit 1
          else
            echo "✅ All functions within complexity thresholds"
          fi

      - name: No TypeScript files changed
        if: steps.changed-files.outputs.any_changed != 'true'
        run: echo "No TypeScript files changed, skipping complexity check."
