Knowledge Bases
Document collections for organized RAG retrieval

Knowledge bases group uploaded documents into named collections that can be queried semantically. Each knowledge base belongs to an organization and is scoped to the user who created it.

The `KnowledgeBase` domain entity holds a name, optional description, org scope (`orgId`), and user ownership (`userId`). The `KnowledgeBaseRepository` port defines persistence operations: save, find by ID, find all by user, delete, plus three source-related methods â€” `assignSourceToKnowledgeBase` (links a source to a knowledge base via direct update), `findSourcesByKnowledgeBaseId` (returns all sources for a knowledge base), and `findSourceByIdAndKnowledgeBaseId` (returns a single source scoped to a knowledge base). A local TypeORM implementation (`LocalKnowledgeBaseRepository`) backs the port with a mapper and `KnowledgeBaseRecord` schema; the source-related methods use `SourceRecord` and `SourceMapper` from the sources module. Domain errors are defined in `knowledge-bases.errors.ts`: `KnowledgeBaseNotFoundError` (404 when a knowledge base is not found) and `DocumentNotInKnowledgeBaseError` (404 when a document does not belong to a knowledge base).

Five CRUD use cases are provided: `CreateKnowledgeBaseUseCase` (persists a new knowledge base), `UpdateKnowledgeBaseUseCase` (updates name/description, verifies ownership), `DeleteKnowledgeBaseUseCase` (removes by ID, verifies ownership), `FindKnowledgeBaseUseCase` (retrieves a single knowledge base by ID and user), and `ListKnowledgeBasesUseCase` (returns all knowledge bases for a user). Each use case has a corresponding command/query DTO.

Three document management use cases handle documents within a knowledge base: `AddDocumentToKnowledgeBaseUseCase` (uploads a file, validates type, and creates a source linked to the knowledge base), `RemoveDocumentFromKnowledgeBaseUseCase` (deletes a document by ID, verifies ownership), and `ListKnowledgeBaseDocumentsUseCase` (returns all documents/sources for a knowledge base). Each has a corresponding command/query DTO.

The HTTP presenter layer exposes a `KnowledgeBasesController` at `/knowledge-bases` with eight endpoints: the five CRUD endpoints (`POST /`, `GET /`, `GET /:id`, `PATCH /:id`, `DELETE /:id`) plus three document endpoints (`GET /:id/documents` to list documents, `POST /:id/documents` for multipart file upload of PDF/DOCX/PPTX, and `DELETE /:id/documents/:documentId` to remove a document, returns 204). The upload endpoint validates the file type using `detectFileType`/`isDocumentFile` utilities and cleans up temporary files. Request DTOs (`CreateKnowledgeBaseDto`, `UpdateKnowledgeBaseDto`) handle input validation, `KnowledgeBaseResponseDto`, `KnowledgeBaseListResponseDto`, `KnowledgeBaseDocumentResponseDto`, and `KnowledgeBaseDocumentListResponseDto` define response shapes, and `KnowledgeBaseDtoMapper` maps domain entities to response DTOs.

The `KnowledgeBasesModule` imports `LocalKnowledgeBaseRepositoryModule` and `SourcesModule`, registers all eight use cases and the DTO mapper as providers, declares the controller, and exports the repository module and use cases for consumption by other modules.
