Knowledge Bases
Document collections for organized RAG retrieval

Knowledge bases group uploaded documents (PDF, DOCX, PPTX) into named collections that can be queried semantically. Each knowledge base belongs to an organization and is scoped to the user who created it.

The `KnowledgeBase` domain entity holds a name, optional description, org scope (`orgId`), and user ownership (`userId`). The `KnowledgeBaseSummary` interface (in `domain/knowledge-base-summary.ts`) is a lightweight projection containing only `id` and `name`, used by other modules (e.g., threads) to reference knowledge bases without loading the full entity. The `KnowledgeBaseRepository` port defines persistence operations: save, find by ID, find all by user, delete, plus three source-related methods â€” `assignSourceToKnowledgeBase` (links a source to a knowledge base via direct update), `findSourcesByKnowledgeBaseId` (returns all sources for a knowledge base), and `findSourceByIdAndKnowledgeBaseId` (returns a single source scoped to a knowledge base). A local TypeORM implementation (`LocalKnowledgeBaseRepository`) backs the port with a mapper and `KnowledgeBaseRecord` schema; the source-related methods use `SourceRecord` and `SourceMapper` from the sources module. Domain errors are defined in `knowledge-bases.errors.ts`: `KnowledgeBaseNotFoundError` (404 when a knowledge base is not found), `DocumentNotInKnowledgeBaseError` (404 when a document does not belong to a knowledge base), and `MissingFileError` (400 when no file is provided).

The `KnowledgeBaseAccessService` is the central service for access control and retrieval of knowledge bases that support shared access. It provides: `findAccessibleKnowledgeBase` (returns a KB if owned or shared with the user), `findAccessibleKnowledgeBaseWithStatus` (returns a KB with its `isShared` flag in a single pass), `findAllAccessible` (returns all owned and shared KBs with share status), and `listAccessibleDocuments` (lists documents in an accessible KB). This service integrates with the shares module to check sharing permissions.

Five CRUD use cases are provided: `CreateKnowledgeBaseUseCase` (persists a new knowledge base), `UpdateKnowledgeBaseUseCase` (updates name/description, verifies ownership), `DeleteKnowledgeBaseUseCase` (removes by ID, verifies ownership), `FindKnowledgeBaseUseCase` (retrieves a single knowledge base by ID and user), and `ListKnowledgeBasesUseCase` (returns all knowledge bases for a user). Each use case has a corresponding command/query DTO.

Three document management use cases handle documents within a knowledge base: `AddDocumentToKnowledgeBaseUseCase` (uploads a file, validates type, and creates a source linked to the knowledge base), `RemoveDocumentFromKnowledgeBaseUseCase` (deletes a document by ID, verifies ownership), and `ListKnowledgeBaseDocumentsUseCase` (returns all documents/sources for a knowledge base, owner-only). Each has a corresponding command/query DTO. A `GetKnowledgeBasesByIdsUseCase` fetches multiple knowledge bases by their IDs in a single query, filtering to the user's organization; it is used by other modules (e.g., skills) to efficiently resolve knowledge base references without crossing module boundaries. A `QueryKnowledgeBaseUseCase` performs semantic search across all documents in a knowledge base using the RAG indexer's `SearchContentUseCase`, returning ranked content chunks. A `GetKnowledgeBaseDocumentTextUseCase` retrieves the full source entity for a specific document within a knowledge base, verifying user ownership and org scope before returning it; this supports the knowledge-get-text tool's need to extract raw document text.

The HTTP presenter layer exposes a `KnowledgeBasesController` at `/knowledge-bases` with eight endpoints: the five CRUD endpoints (`POST /`, `GET /`, `GET /:id`, `PATCH /:id`, `DELETE /:id`) plus three document endpoints (`GET /:id/documents` to list documents, `POST /:id/documents` for multipart file upload of PDF/DOCX/PPTX, `POST /:id/urls` for adding URL sources, and `DELETE /:id/documents/:documentId` to remove a document, returns 204). The `GET /`, `GET /:id`, and `GET /:id/documents` endpoints delegate to `KnowledgeBaseAccessService` for access-controlled retrieval supporting both owned and shared knowledge bases. Write operations (`POST`, `PATCH`, `DELETE`) delegate to their respective use cases and require ownership. The upload endpoint validates the file type using `detectFileType`/`isDocumentFile` utilities and cleans up temporary files. Request DTOs (`CreateKnowledgeBaseDto`, `UpdateKnowledgeBaseDto`) handle input validation, `KnowledgeBaseResponseDto`, `KnowledgeBaseListResponseDto`, `KnowledgeBaseDocumentResponseDto`, and `KnowledgeBaseDocumentListResponseDto` define response shapes, and `KnowledgeBaseDtoMapper` maps domain entities to response DTOs.

The `KnowledgeBasesModule` imports `LocalKnowledgeBaseRepositoryModule`, `SourcesModule`, `IndexersModule`, `ContextModule`, and `SharesModule`, registers all use cases, the `KnowledgeBaseAccessService`, and the DTO mapper as providers, declares the controller, and exports the repository module, access service, and use cases for consumption by other modules. The module integrates with **sources** for document storage and chunking, **indexers** for semantic indexing and multi-document vector search, and **shares** for cross-user access control.
