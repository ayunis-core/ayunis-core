Conversation Sessions
Conversation threads linking messages, models, and sources

Threads are conversation containers that hold message histories, bind to a language model and optional agent, and support source attachments and knowledge base assignments for per-conversation RAG context enrichment.

The threads module manages conversation sessions. The `Thread` entity holds a message list, optional `PermittedLanguageModel` reference, optional agent binding, source assignments, knowledge base assignments, title, and anonymous flag. `SourceAssignment` links data sources to individual threads and carries an optional `originSkillId` provenance field that tracks which skill caused the source to be attached — this enables cleanup when a skill share is revoked. The `KnowledgeBaseAssignment` entity represents a knowledge base attached to a thread; the underlying `thread_knowledge_base_assignments` table stores the thread ID, knowledge base ID, and an optional `originSkillId` provenance column that tracks which skill caused the assignment. This provenance tracking enables targeted cleanup when a skill share is revoked or when a knowledge base is removed from a skill — only assignments originating from that skill are deleted, leaving user-initiated (direct) assignments intact. Key use cases include creating threads, finding threads (single, all, by org with sources), updating titles, deleting threads, adding/removing sources, adding/removing knowledge bases from threads (`AddKnowledgeBaseToThreadUseCase`, `RemoveKnowledgeBaseFromThreadUseCase`), removing skill-originated KB assignments (`RemoveKnowledgeBaseAssignmentsByOriginSkillUseCase`), removing direct KB assignments (`RemoveDirectKnowledgeBaseFromThreadsUseCase`), removing skill-originated sources from threads, generating titles via AI inference, and replacing models with user defaults. The add-knowledge-base use case validates org-scoping (the knowledge base must belong to the caller's org) and deduplicates; the remove use case is idempotent when the knowledge base is not assigned. Thread title generation uses the language model to auto-summarize conversation content. The `ShareDeletedListener` listens for skill and knowledge base share deletion events: for skill shares it uses `RemoveSkillSourcesFromThreadsUseCase` and `RemoveKnowledgeBaseAssignmentsByOriginSkillUseCase` to clean up assignments that were attached via the revoked skill; for KB shares it uses `RemoveDirectKnowledgeBaseFromThreadsUseCase` to remove direct KB assignments — targeting only users who lost access (resolved via `ShareScopeResolverService.resolveLostAccessUserIds`). The `ThreadMapper` was refactored to use private helper methods (`mapModel`, `mapSourceAssignments`, `mapMcpIntegrationIds`, `mapKnowledgeBases`, `mapMessages`) for readability and to support the new `knowledgeBases` field. The HTTP layer exposes `POST /threads/:id/knowledge-bases/:knowledgeBaseId` (add) and `DELETE /threads/:id/knowledge-bases/:knowledgeBaseId` (remove), both returning 204 No Content. The `GetThreadResponseDto` and `GetThreadDtoMapper` include the `knowledgeBases` array (as `KnowledgeBaseSummaryResponseDto`). The module integrates with **messages** for conversation content storage, **models** for model selection per thread, **agents** for agent-bound conversations, **sources** for attaching RAG data, **knowledge-bases** for attaching org-scoped knowledge bases to threads, **runs** which execute within thread context, **shares** indirectly through skill share deletion events, and **IAM** (users, teams) for resolving which users lost access on share revocation.

**Future work:** MCP integrations on threads currently use a bare `@ManyToMany` join table (`thread_mcp_integrations`) without provenance tracking. When user-group-scoped MCP integration access is added, this table should be promoted to a proper entity (like `ThreadSourceAssignmentRecord`) with an `originSkillId` (or similar provenance) column, following the same pattern used for source assignments. This will enable the same cleanup-on-revocation behavior for MCP integrations.
